{"version":3,"sources":["../../src/common/InterferenceGameEngine.js"],"names":["scaleTable","palettes","InterferenceGameEngine","options","physicsEngine","SimplePhysicsEngine","gameEngine","collisions","autoResolve","Object","assign","cellSize","playerWidth","playerHeight","leftBound","topBound","bottomBound","transportSyncInterval","eggRadius","eggBaseXVelocity","rooms","playersByRoom","eggsByRoom","rightBoundByRoom","on","preStepLogic","bind","postStepLogic","serializer","registerClass","Performer","Egg","roomName","x","Math","random","length","y","TwoVector","stepInfo","groupBy","world","queryObjects","instanceType","keys","r","resolveCollisions","gameLogic","e","position","velocity","emit","arr","property","reduce","grouped","current","push","inputData","playerId","isServer","player","queryObject","players","_roomName","input","stage","palette","indexOf","console","log","newNumber","number","p","scale","notestack","concat","String","fromCharCode","floor","GameEngine"],"mappings":"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","sourcesContent":["import { GameEngine, SimplePhysicsEngine, TwoVector } from 'lance-gg';\nimport Performer from './Performer';\nimport Egg from './Egg';\n\nconst scaleTable = {\n    'rain':     [60, 64, 66, 69, 71],\n    'celeste':  [60, 62, 63, 65, 67],\n    'pyre':     [60, 62, 63, 67, 70],\n    'journey':  [60, 62, 64, 67, 69],\n    'kirby':    [60, 62, 64, 65, 67],\n    'default':  [60, 62, 64, 65, 67]\n}\nconst palettes = ['rain', 'celeste', 'pyre', 'journey', 'kirby'];\n\nexport default class InterferenceGameEngine extends GameEngine {\n\n    constructor(options) {\n        super(options);\n        this.physicsEngine = new SimplePhysicsEngine({\n            gameEngine: this,\n            collisions: { autoResolve: false }\n        });\n\n        // game constants\n        Object.assign(this, {\n            cellSize: 1, playerWidth: 16, playerHeight: 9,\n            leftBound: 0, topBound: 0, bottomBound: 9,\n            transportSyncInterval: 200, eggRadius: 1, eggBaseXVelocity: 0.1\n        });\n\n        // game variables\n        Object.assign(this, {\n            rooms: [], playersByRoom: {}, eggsByRoom: {}, rightBoundByRoom: {}\n        });\n\n        this.on('preStep', this.preStepLogic.bind(this));\n        this.on('postStep', this.postStepLogic.bind(this));\n    }\n\n    registerClasses(serializer) {\n        serializer.registerClass(Performer);\n        serializer.registerClass(Egg);\n    }\n\n    start() {\n        super.start();\n    }\n\n    randPos(roomName) {\n        let x = Math.random() * this.playerWidth * this.playersByRoom[roomName].length;\n        let y = Math.random() * this.playerHeight;\n        return new TwoVector(x, y);\n    }\n\n    velRandY() {\n        let y = (Math.random() - 0.5) * this.eggBaseXVelocity;\n        return new TwoVector(this.eggBaseXVelocity, y);\n    }\n\n    preStepLogic(stepInfo) {\n        this.playersByRoom = this.groupBy(this.world.queryObjects({ instanceType: Performer }), \"_roomName\");\n        this.rooms = Object.keys(this.playersByRoom);\n        this.eggsByRoom = this.groupBy(this.world.queryObjects({ instanceType: Egg }), \"_roomName\");\n        this.rightBoundByRoom = {};\n        for (let r of this.rooms) {\n            this.rightBoundByRoom[r] = this.playersByRoom[r].length * this.playerWidth;\n        }\n    }\n\n    postStepLogic(stepInfo) {\n        for (let r of this.rooms) {\n            this.resolveCollisions(r);\n            this.gameLogic(r);\n        }\n    }\n\n    resolveCollisions(r) {\n        /*\n        if (stepInfo.isReenact)\n            return;\n        */\n\n        if (this.eggsByRoom[r]) {\n            for (let e of this.eggsByRoom[r]) {\n                // bounce off walls\n                if ((e.position.x - this.eggRadius) < this.leftBound) {\n                    e.velocity.x *= -1;\n                    e.position.x = this.leftBound + this.eggRadius;\n                    this.emit('eggBounce', e);\n                } \n                else if ((e.position.x + this.eggRadius) > this.rightBoundByRoom[r]) {\n                    e.velocity.x *= -1;\n                    e.position.x = this.rightBoundByRoom[r] - this.eggRadius;\n                    this.emit('eggBounce', e);\n                }\n                if ((e.position.y - this.eggRadius) < this.topBound) {\n                    e.velocity.y *= -1\n                    e.position.y = this.topBound + this.eggRadius;\n                    this.emit('eggBounce', e);\n                }\n                else if ((e.position.y + this.eggRadius) > this.bottomBound) {\n                    e.velocity.y *= -1\n                    e.position.y = this.bottomBound - this.eggRadius;\n                    this.emit('eggBounce', e);\n                }\n            }\n        }\n        \n                        /*\n        this.world.forEachObject((id, obj) => {\n            if (obj instanceof Egg) {\n\n                // if the position changed, add a body part and trim the length\n                let pos = obj.position.clone();\n                if (obj.bodyParts.length === 0 || pos.subtract(obj.bodyParts[obj.bodyParts.length-1]).length() > 0.05) {\n                    obj.bodyParts.push(obj.position.clone());\n                    while (obj.bodyLength < obj.bodyParts.length) obj.bodyParts.shift();\n                }\n\n                // if not stopped, move along\n                if (obj.direction === this.directionStop) return;\n                let move = new TwoVector(Math.cos(obj.direction), Math.sin(obj.direction));\n                move.multiplyScalar(0.05);\n                obj.position.add(move);\n                obj.position.y = Math.min(obj.position.y, this.spaceHeight / 2);\n                obj.position.y = Math.max(obj.position.y, -this.spaceHeight / 2);\n                obj.position.x = Math.min(obj.position.x, this.spaceWidth / 2);\n                obj.position.x = Math.max(obj.position.x, -this.spaceWidth / 2);\n\n            }\n        });                */\n    }\n\n    gameLogic(r) {\n\n    }\n\n    groupBy(arr, property) {\n        return arr.reduce((grouped, current) => {\n            if (!grouped[current[property]]) grouped[current[property]] = [];\n            grouped[current[property]].push(current);\n            return grouped;\n        }, {});\n    }\n\n    processInput(inputData, playerId, isServer) {\n\n        super.processInput(inputData, playerId);\n        \n        let player = this.world.queryObject({ playerId });\n        let players = this.playersByRoom[player._roomName];\n\n        if (inputData.input == 'c') {\n            if (player.stage === 'setup') {\n                player.palette = palettes[(palettes.indexOf(player.palette)+1)%palettes.length];\n                console.log(player.palette);\n            }\n        }\n        \n        if (isServer) { \n        // stuff that should only be processed on the server, such as randomness, which would otherwise cause discrepancies\n        // or actions that require more info than is available to one player\n            //console.log(inputData.input);\n            if (player.stage === 'setup') {\n                if (inputData.input == '[') {\n                    let newNumber = player.number - 1;\n                    if (newNumber < 0) newNumber = players.length - 1;\n                    for (let p of players) { \n                        if (p.number === newNumber) p.number = player.number; \n                    }\n                    player.number = newNumber;\n                }\n                else if (inputData.input == ']') {\n                    let newNumber = player.number + 1;\n                    if (newNumber >= players.length) newNumber = 0;\n                    for (let p of players) { \n                        if (p.number === newNumber) p.number = player.number; \n                    }\n                    player.number = newNumber;\n                } \n                else if (inputData.input == 'b') {\n                    this.emit('beginPerformance', player);\n                }\n            }\n            else if (player.stage === 'intro') {\n                if (inputData.input == 'b') {\n                    this.emit('beginPerformance', player);\n                }\n            }\n            else if (inputData.input == 'n') {\n                let scale = scaleTable[player.palette];\n                player.notestack = player.notestack.concat(\n                    String.fromCharCode(scale[Math.floor(Math.random() * scale.length)])\n                );\n                console.log(player.notestack);\n            }\n\n\n        }\n    }\n}\n"],"file":"InterferenceGameEngine.js"}