{"version":3,"sources":["../../src/server/InterferenceServerEngine.js"],"names":["palettes","InterferenceServerEngine","io","gameEngine","inputOptions","myRooms","syncServers","on","stepLogic","bind","socket","roomName","Object","keys","includes","createRoom","createSyncServer","player","number","length","palette","console","log","push","assignPlayerToRoom","playerId","assignObjectToRoom","assignPlayerToSyncServer","emit","Performer","notestack","rhythmstack","addObjectToWorld","startTime","process","hrtime","SyncServer","now","start","pingId","clientPingTime","serverPingTime","serverPongTime","response","callback","data","request","socketId","world","queryObject","removed","removeObjectFromWorld","id","k","splice","indexOf","p","players","queryObjects","instanceType","eggs","Egg","ServerEngine"],"mappings":"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","sourcesContent":["import { ServerEngine } from 'lance-gg';\nimport SyncServer from '@ircam/sync/server';\nimport Performer from '../common/Performer';\nimport Egg from '../common/Egg';\n\nconst palettes = ['rain', 'celeste', 'pyre', 'journey', 'kirby'];\n\nexport default class InterferenceServerEngine extends ServerEngine {\n\n    constructor(io, gameEngine, inputOptions) {\n        super(io, gameEngine, inputOptions);\n\n        this.myRooms = {}; //roomName: [players in the room]\n        this.syncServers = {} //roomName: syncServer\n\n        this.gameEngine.on('postStep', this.stepLogic.bind(this));\n    }\n\n    // create food and AI robots\n    start() {\n        super.start();\n        /*\n        for (let f = 0; f < this.gameEngine.foodCount; f++) {\n            let newF = new Egg(this.gameEngine, null, { position: this.gameEngine.randPos() });\n            this.gameEngine.addObjectToWorld(newF);\n        }\n        */\n    }\n\n    onPlayerConnected(socket) {\n        super.onPlayerConnected(socket);\n\n        socket.on('assignToRoom', roomName => {\n            if (!Object.keys(this.myRooms).includes(roomName)) {\n                this.createRoom(roomName);\n                this.createSyncServer(roomName);\n                this.myRooms[roomName] = [];\n            }\n            player.number = this.myRooms[roomName].length;\n            player.palette = palettes[player.number%palettes.length];\n            console.log(player.number);\n            this.myRooms[roomName].push(player);\n            this.assignPlayerToRoom(player.playerId, roomName);\n            this.assignObjectToRoom(player, roomName);\n            this.assignPlayerToSyncServer(socket, roomName);\n            socket.emit('assignedRoom', roomName);\n        });\n\n        let player = new Performer(this.gameEngine, null, {});\n        player.number = -1;\n        player.palette = 'default';\n        player.notestack = '';\n        player.rhythmstack = '';\n        console.log(player.number);\n        player.playerId = socket.playerId;\n        this.gameEngine.addObjectToWorld(player);\n    }\n\n    createSyncServer(roomName) {\n        const startTime = process.hrtime();\n        this.syncServers[roomName] = new SyncServer(() => {\n            let now = process.hrtime(startTime);\n            return now[0] + now[1] * 1e-9;\n        });\n    }\n\n    assignPlayerToSyncServer(socket, roomName) {\n        this.syncServers[roomName].start(\n        // sync send function\n        (pingId, clientPingTime, serverPingTime, serverPongTime) => {\n            //console.log(`[pong] - id: %s, clientPingTime: %s, serverPingTime: %s, serverPongTime: %s`,\n            //  pingId, clientPingTime, serverPingTime, serverPongTime);\n            const response = [];\n            response[0] = 1; // this is a pong\n            response[1] = pingId;\n            response[2] = clientPingTime;\n            response[3] = serverPingTime;\n            response[4] = serverPongTime;\n            socket.emit('syncServerData', response);\n        }, \n        //sync receive function\n        callback => {\n            socket.on('syncClientData', data => {\n                const request = data;\n\n                if (request[0] === 0) { // this is a ping\n                    const pingId = request[1];\n                    const clientPingTime = request[2];\n\n                    //console.log(`[ping] - pingId: %s, clientPingTime: %s`, clientPingTime);\n\n                    callback(pingId, clientPingTime);\n                }\n            });\n        });\n    }\n\n    onPlayerDisconnected(socketId, playerId) {\n        super.onPlayerDisconnected(socketId, playerId);\n        let player = this.gameEngine.world.queryObject({ playerId });\n        if (player) { \n            let removed = player.number;\n            this.gameEngine.removeObjectFromWorld(player.id);\n            for (let k of Object.keys(this.myRooms)) {\n                if (this.myRooms[k].includes(player)) {\n                    this.myRooms[k].splice(this.myRooms[k].indexOf(player), 1);\n                    for (let p of this.myRooms[k]) if (p.number > removed) p.number--; \n                }\n            }\n        }\n    }\n\n    /*\n    // Eating Egg:\n    // increase body length, and remove the food\n    wiggleEatFood(w, f) {\n        if (!(f.id in this.gameEngine.world.objects))\n            return;\n\n        w.bodyLength++;\n        this.gameEngine.removeObjectFromWorld(f);\n        let newF = new Egg(this.gameEngine, null, { position: this.gameEngine.randPos() });\n        this.gameEngine.addObjectToWorld(newF);\n    }\n\n    wiggleHitWiggle(w1, w2) {\n        if (!(w2.id in this.gameEngine.world.objects) || !(w1.id in this.gameEngine.world.objects))\n            return;\n\n        this.gameEngine.removeObjectFromWorld(w1);\n        if (w1.AI) this.addAI();\n    }\n    */\n    stepLogic() {\n\n        let players = this.gameEngine.world.queryObjects({ instanceType: Performer });\n        let eggs = this.gameEngine.world.queryObjects({ instanceType: Egg });\n        for (let p of players) {\n            /*\n            // check for collision\n            for (let w2 of wiggles) {\n                if (w === w2)\n                    continue;\n\n                for (let i = 0; i < w2.bodyParts.length; i++) {\n                    let distance = w2.bodyParts[i].clone().subtract(w.position);\n                    if (distance.length() < this.gameEngine.collideDistance)\n                        this.wiggleHitWiggle(w, w2);\n                }\n            }\n\n            // check for food-eating\n            for (let f of foodObjects) {\n                let distance = w.position.clone().subtract(f.position);\n                if (distance.length() < this.gameEngine.eatDistance) {\n                    this.wiggleEatFood(w, f);\n                }\n            }\n\n            // move AI wiggles\n            if (w.AI) {\n                if (Math.random() < 0.01) w.turnDirection *= -1;\n                w.direction += w.turnDirection * (Math.random() - 0.9)/20;\n                if (w.position.y >= this.gameEngine.spaceHeight / 2) w.direction = -Math.PI/2;\n                if (w.position.y <= -this.gameEngine.spaceHeight / 2) w.direction = Math.PI/2;\n                if (w.position.x >= this.gameEngine.spaceWidth / 2) w.direction = Math.PI;\n                if (w.position.x <= -this.gameEngine.spaceWidth / 2) w.direction = 0;\n                if (w.direction > Math.PI * 2) w.direction -= Math.PI * 2;\n                if (w.direction < 0) w.direction += Math.PI * 2;\n            }\n            */\n        }\n\n    \n    }\n}\n"],"file":"InterferenceServerEngine.js"}